name: çƒ­æ¦œçˆ¬å– (Vercel + Redis)

on:
  schedule:
    # æ¯ 30 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ (UTC æ—¶é—´)
    - cron: "*/30 * * * *"

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  trigger-crawl:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    # é˜²æ­¢å¹¶å‘æ‰§è¡Œ
    concurrency:
      group: crawl-hotlist-vercel
      cancel-in-progress: false

    steps:
      - name: è°ƒç”¨ Vercel çˆ¬å–ç«¯ç‚¹
        env:
          VERCEL_ENDPOINT: ${{ secrets.VERCEL_ENDPOINT }}
          CRAWL_TOKEN: ${{ secrets.CRAWL_TOKEN }}
        run: |
          set -euo pipefail

          echo "ğŸš€ å¼€å§‹è§¦å‘çƒ­æ¦œçˆ¬å–..."
          echo "â° æ‰§è¡Œæ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"

          # é‡è¯• 3 æ¬¡ï¼Œæ¯æ¬¡è¶…æ—¶ 50 ç§’
          for i in 1 2 3; do
            echo "ğŸ“¡ å°è¯•ç¬¬ $i æ¬¡..."

            if curl -fsS -m 50 \
              -H "Authorization: Bearer ${CRAWL_TOKEN}" \
              -H "Content-Type: application/json" \
              "${VERCEL_ENDPOINT}"; then
              echo "âœ… çˆ¬å–è§¦å‘æˆåŠŸï¼"
              exit 0
            else
              echo "âŒ ç¬¬ $i æ¬¡å°è¯•å¤±è´¥"
              if [ $i -lt 3 ]; then
                echo "â³ ç­‰å¾… 15 ç§’åé‡è¯•..."
                sleep 15
              fi
            fi
          done

          echo "ğŸ’” æ‰€æœ‰å°è¯•å‡å¤±è´¥"
          exit 1

      - name: è®°å½•æ‰§è¡Œç»“æœ
        if: always()
        run: |
          echo "ğŸ“Š æ‰§è¡Œå®Œæˆæ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
